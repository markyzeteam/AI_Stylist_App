# âœ… FINAL OPTIMIZED FLOW: 2 Gemini Calls, 4 Analysis Sections

**Date:** October 22, 2025
**Status:** APPROVED - Ready to implement

---

## ğŸ¯ **FINAL USER FLOW**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. BODY SHAPE QUIZ                 â”‚
â”‚  - Gender, age, measurements        â”‚
â”‚  - Calculate shape locally          â”‚
â”‚  - Store data (no results yet)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. COLOR SEASON QUIZ                â”‚
â”‚  - Skin tone, hair, eyes questions  â”‚
â”‚  - Calculate season locally         â”‚
â”‚  - Store data (no results yet)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. VALUES QUIZ                      â”‚
â”‚  - Sustainability                   â”‚
â”‚  - Budget range                     â”‚
â”‚  - Style preferences                â”‚
â”‚  - Store data (no results yet)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
      [GEMINI CALL #1]
      Pass ALL data:
      - Body shape + measurements
      - Color season + analysis
      - Values + preferences
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. â­ COMBINED RESULTS PAGE â­      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ‘— BODY SHAPE ANALYSIS       â”‚  â”‚
â”‚  â”‚ - AI-generated analysis      â”‚  â”‚
â”‚  â”‚ - Style goals               â”‚  â”‚
â”‚  â”‚ - Recommendations           â”‚  â”‚
â”‚  â”‚ - Pro tips                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸŒ¸ COLOR SEASON ANALYSIS     â”‚  â”‚
â”‚  â”‚ - AI-generated analysis      â”‚  â”‚
â”‚  â”‚ - Best colors palette        â”‚  â”‚
â”‚  â”‚ - Colors to avoid           â”‚  â”‚
â”‚  â”‚ - Styling tips              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ’š VALUES ANALYSIS           â”‚  â”‚
â”‚  â”‚ - AI analysis of values      â”‚  â”‚
â”‚  â”‚ - Personalized brand recs    â”‚  â”‚
â”‚  â”‚ - Shopping strategies        â”‚  â”‚
â”‚  â”‚ - Budget-friendly tips       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â­ CELEBRITY MATCHES          â”‚  â”‚
â”‚  â”‚ - Based on body + color +    â”‚  â”‚
â”‚  â”‚   style preferences          â”‚  â”‚
â”‚  â”‚ - Styling tips from celebs   â”‚  â”‚
â”‚  â”‚ - Signature pieces           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚
â”‚  [ğŸ›ï¸ Show Me Products!]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
      [GEMINI CALL #2]
      Use all quiz data + analyses
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. PRODUCT RECOMMENDATIONS          â”‚
â”‚  - Personalized products            â”‚
â”‚  - Based on ALL quiz data           â”‚
â”‚  - Reasoning & styling tips         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’° **COST BREAKDOWN**

### Combined Analysis Call #1:
```javascript
Input Data:
- Body shape + measurements (6 data points)
- Color season + analysis (3 data points)
- Values + preferences (3+ data points)

Gemini Processing:
- Body shape analysis generation
- Color season analysis generation
- VALUES analysis generation (NEW!)
- Celebrity recommendations

Estimated Tokens:
- Input: ~1,500 tokens
- Output: ~8,000 tokens (4 sections)

Cost: ~$0.003-0.004 per user
```

### Product Recommendations Call #2:
```javascript
Input Data:
- All quiz data
- Body shape
- Color season
- Values preferences
- 1,000 products with cached analysis

Estimated Tokens:
- Input: ~500,000 tokens
- Output: ~9,000 tokens

Cost: ~$0.050 per user
```

**Total Cost: $0.053-0.054 per user**

**Savings vs Current: 3.6% reduction**

---

## ğŸ¨ **COMBINED RESULTS PAGE DESIGN**

```html
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           YOUR COMPLETE STYLE PROFILE                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘— YOUR BODY SHAPE: HOURGLASS                           â”‚
â”‚                                                          â”‚
â”‚  Your hourglass shape is naturally beautiful and         â”‚
â”‚  balanced â€” bust and hips in harmony, with that lovely   â”‚
â”‚  defined waist. Simple pieces that celebrate your        â”‚
â”‚  curves without fuss will make you feel confident all    â”‚
â”‚  day long.                                               â”‚
â”‚                                                          â”‚
â”‚  Style Goals:                                            â”‚
â”‚  â€¢ Show off your natural waistline with ease             â”‚
â”‚  â€¢ Choose pieces that feel as good as they look          â”‚
â”‚  â€¢ Embrace your curves with comfortable fits             â”‚
â”‚                                                          â”‚
â”‚  Recommendations:                                        â”‚
â”‚  â€¢ Wrap dresses that define your waist                   â”‚
â”‚  â€¢ Fitted blouses with soft fabrics                      â”‚
â”‚  â€¢ High-waisted jeans and trousers                       â”‚
â”‚                                                          â”‚
â”‚  Pro Tips:                                               â”‚
â”‚  â€¢ Always define your waist with belts or fitted styles  â”‚
â”‚  â€¢ V-necks and scoop necks flatter your neckline         â”‚
â”‚  â€¢ Stretchy structured fabrics are your best friend      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸŒ¸ YOUR COLOR SEASON: SPRING                            â”‚
â”‚                                                          â”‚
â”‚  Spring coloring means you have warm undertones with     â”‚
â”‚  bright, clear intensity. Light, fresh colors that       â”‚
â”‚  reflect sunshine and new growth make you glow.          â”‚
â”‚                                                          â”‚
â”‚  Your Best Colors:                                       â”‚
â”‚  ğŸ¨ Coral â€¢ Peach â€¢ Warm Pink â€¢ Turquoise â€¢ Golden Yellowâ”‚
â”‚                                                          â”‚
â”‚  Color Palette:                                          â”‚
â”‚  Neutrals: Ivory, Camel, Warm Beige                     â”‚
â”‚  Accents: Coral Pink, Turquoise, Spring Green           â”‚
â”‚  Statements: Bright Orange, Clear Aqua, Warm Red        â”‚
â”‚                                                          â”‚
â”‚  Colors to Avoid:                                        â”‚
â”‚  â€¢ Black (too harsh) â†’ Try warm brown instead           â”‚
â”‚  â€¢ Cool blue-reds â†’ Stick with warm coral reds          â”‚
â”‚  â€¢ Dusty muted tones â†’ Go for bright clear colors       â”‚
â”‚                                                          â”‚
â”‚  Styling Tips:                                           â”‚
â”‚  â€¢ Wear your best colors near your face                 â”‚
â”‚  â€¢ Mix warm neutrals with bright accents                â”‚
â”‚  â€¢ Gold jewelry complements your warm tones              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’š YOUR VALUES & SHOPPING STYLE                         â”‚
â”‚                                                          â”‚
â”‚  You care about sustainability and conscious shopping,   â”‚
â”‚  with a budget-friendly approach and love for casual,    â”‚
â”‚  minimalist style. This thoughtful combination makes     â”‚
â”‚  building a timeless wardrobe both meaningful and        â”‚
â”‚  achievable.                                             â”‚
â”‚                                                          â”‚
â”‚  Brands Perfect For You:                                 â”‚
â”‚  â€¢ Everlane - Transparent pricing, sustainable basics    â”‚
â”‚  â€¢ Pact - Organic cotton, affordable essentials         â”‚
â”‚  â€¢ Tentree - Plants trees, casual minimalist style      â”‚
â”‚  â€¢ Reformation - Eco-friendly, trendy pieces            â”‚
â”‚                                                          â”‚
â”‚  Smart Shopping Strategies:                              â”‚
â”‚  â€¢ Build a capsule wardrobe with versatile pieces       â”‚
â”‚  â€¢ Invest in quality basics that last years             â”‚
â”‚  â€¢ Shop end-of-season sales at sustainable brands       â”‚
â”‚  â€¢ Mix high and low - splurge on classics, save on      â”‚
â”‚    trends                                                â”‚
â”‚                                                          â”‚
â”‚  Budget-Friendly Tips:                                   â”‚
â”‚  â€¢ Cost per wear: $50 item worn 50 times = $1/wear     â”‚
â”‚  â€¢ Quality over quantity builds lasting style           â”‚
â”‚  â€¢ Secondhand shopping for designer sustainable pieces  â”‚
â”‚  â€¢ Subscribe to brand newsletters for early sale access â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â­ CELEBRITIES WHO MATCH YOUR STYLE                     â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  [PHOTO]  SCARLETT JOHANSSON                       â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚  Match Reason:                                      â”‚ â”‚
â”‚  â”‚  Scarlett shares your hourglass shape, Spring      â”‚ â”‚
â”‚  â”‚  coloring with warm undertones, and gravitates     â”‚ â”‚
â”‚  â”‚  toward casual-elegant minimalist pieces that      â”‚ â”‚
â”‚  â”‚  celebrate natural curves without being fussy.     â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚  Styling Tips:                                      â”‚ â”‚
â”‚  â”‚  â€¢ Copy her wrap dress look with defined waist     â”‚ â”‚
â”‚  â”‚  â€¢ Try her signature warm coral and peach tones    â”‚ â”‚
â”‚  â”‚  â€¢ Embrace fitted basics in sustainable fabrics    â”‚ â”‚
â”‚  â”‚                                                     â”‚ â”‚
â”‚  â”‚  Signature Pieces:                                  â”‚ â”‚
â”‚  â”‚  â€¢ Fitted wrap dresses                             â”‚ â”‚
â”‚  â”‚  â€¢ Simple tailored blazers                         â”‚ â”‚
â”‚  â”‚  â€¢ High-waisted jeans                              â”‚ â”‚
â”‚  â”‚  â€¢ Classic pumps in neutral tones                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  [2-3 more celebrity matches...]                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚         [ğŸ›ï¸ Show Me Products That Match!]               â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ **NEW API ENDPOINT STRUCTURE**

### **POST `/api/gemini/combined-analysis`**

**Request Body:**
```typescript
{
  // Body shape data
  bodyShape: string;              // "Hourglass", "Pear", etc.
  measurements: {
    gender: string;               // "woman", "man", "non-binary"
    age: string;                  // "25-34"
    bust: number;                 // cm
    waist: number;                // cm
    hips: number;                 // cm
    shoulders: number;            // cm
  };

  // Color season data
  colorSeason: string;            // "Spring", "Summer", etc.
  colorAnalysis: {
    undertone: string;            // "warm", "cool", "neutral"
    depth: string;                // "light", "medium", "deep"
    intensity: string;            // "bright", "muted", "clear"
  };

  // Values data
  valuesPreferences: {
    sustainability: boolean;       // true/false
    budgetRange: string;          // "low", "medium", "high", "luxury"
    styles: string[];             // ["Casual", "Minimalist", "Bohemian"]
  };

  shop: string;                   // Shop domain
}
```

**Response:**
```typescript
{
  success: boolean;

  // Section 1: Body Shape Analysis
  bodyShapeAnalysis: {
    analysis: string;             // 2-3 paragraphs AI-generated
    styleGoals: string[];         // 3-4 goals
    recommendations: Array<{
      category: string;           // "Dresses", "Tops", etc.
      items: string[];            // Specific items
      reasoning: string;          // Why they work
      stylingTips: string;        // How to wear them
    }>;
    avoidItems: Array<{
      item: string;
      reason: string;
    }>;
    proTips: string[];            // 3-4 tips
  };

  // Section 2: Color Season Analysis
  colorSeasonAnalysis: {
    analysis: string;             // 2-3 paragraphs AI-generated
    bestColors: string[];         // 5-6 colors
    colorPalette: Array<{
      category: string;           // "Neutrals", "Accents", etc.
      colors: string[];           // Color names
      reasoning: string;          // Why they work
    }>;
    avoidColors: Array<{
      color: string;
      reason: string;
    }>;
    stylingTips: string[];        // 4-5 tips
  };

  // Section 3: Values Analysis (NEW!)
  valuesAnalysis: {
    analysis: string;             // AI-generated personalized analysis
    recommendedBrands: Array<{
      brand: string;
      reason: string;             // Why it matches their values
      priceRange: string;
    }>;
    shoppingStrategies: string[]; // Smart shopping tips
    budgetTips: string[];         // Budget-specific advice
  };

  // Section 4: Celebrity Matches
  celebrityRecommendations: {
    summary: string;              // 2-3 sentence overview
    celebrities: Array<{
      name: string;
      matchReason: string;        // Why they match (body+color+style)
      stylingTips: string[];      // 3 tips
      signaturePieces: string[];  // 3-4 pieces
      imageSearchQuery: string;   // For loading images
    }>;
  };
}
```

---

## ğŸš€ **IMPLEMENTATION PLAN**

### Phase 1: Create Combined Endpoint âœ…
```typescript
// File: app/routes/api.gemini.combined-analysis.tsx

import { GoogleGenerativeAI } from "@google/generative-ai";
import { loadGeminiSettings } from "../utils/geminiAnalysis";

export async function action({ request }) {
  const body = await request.json();

  // Extract all quiz data
  const {
    bodyShape, measurements,
    colorSeason, colorAnalysis,
    valuesPreferences,
    shop
  } = body;

  // Load settings
  const geminiSettings = await loadGeminiSettings(shop);

  // Build comprehensive prompt
  const prompt = buildCombinedAnalysisPrompt({
    bodyShape, measurements,
    colorSeason, colorAnalysis,
    valuesPreferences,
    geminiSettings
  });

  // Call Gemini
  const genAI = new GoogleGenerativeAI(apiKey);
  const model = genAI.getGenerativeModel({
    model: geminiSettings.model
  });

  const result = await model.generateContent({
    contents: [{ role: "user", parts: [{ text: prompt }] }],
    generationConfig: {
      temperature: 0.7,
      maxOutputTokens: 8192,
      responseMimeType: "application/json"
    }
  });

  // Parse and return
  const analysis = JSON.parse(result.response.text());

  return json({
    success: true,
    bodyShapeAnalysis: analysis.bodyShapeAnalysis,
    colorSeasonAnalysis: analysis.colorSeasonAnalysis,
    valuesAnalysis: analysis.valuesAnalysis,
    celebrityRecommendations: analysis.celebrityRecommendations
  });
}
```

### Phase 2: Build Combined Prompt âœ…
```typescript
function buildCombinedAnalysisPrompt(data) {
  const { bodyShape, measurements, colorSeason, colorAnalysis, valuesPreferences, geminiSettings } = data;

  // Use custom prompts from settings
  const systemPrompt = geminiSettings.bodyShapePrompt || DEFAULT_PROMPT;

  return `${systemPrompt}

You are analyzing a customer who has completed a comprehensive style assessment. Provide detailed, personalized analysis across FOUR areas:

CUSTOMER PROFILE:
Body Shape: ${bodyShape}
Measurements:
- Gender: ${measurements.gender}
- Age: ${measurements.age}
- Bust: ${measurements.bust} cm
- Waist: ${measurements.waist} cm
- Hips: ${measurements.hips} cm
- Shoulders: ${measurements.shoulders} cm

Color Season: ${colorSeason}
Color Characteristics:
- Undertone: ${colorAnalysis.undertone}
- Depth: ${colorAnalysis.depth}
- Intensity: ${colorAnalysis.intensity}

Values & Preferences:
- Sustainability Focus: ${valuesPreferences.sustainability ? 'Yes' : 'No'}
- Budget Range: ${valuesPreferences.budgetRange}
- Style Preferences: ${valuesPreferences.styles.join(', ')}

Provide a comprehensive JSON response with these sections:
{
  "bodyShapeAnalysis": { ... },
  "colorSeasonAnalysis": { ... },
  "valuesAnalysis": { ... },
  "celebrityRecommendations": { ... }
}

Make it warm, personal, and actionable. Use the CJLA tone - friendly, encouraging, heart-centered.`;
}
```

### Phase 3: Update Frontend âœ…
```javascript
// Remove intermediate result pages
async completeFinalQuiz() {
  // After values quiz, call combined analysis
  const response = await fetch('/api/gemini/combined-analysis', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      bodyShape: this.bodyShapeResult.shape,
      measurements: this.measurements,
      colorSeason: this.colorSeasonResult,
      colorAnalysis: this.colorAnalysis,
      valuesPreferences: this.valuesPreferences,
      shop: this.config.shopDomain
    })
  });

  const data = await response.json();

  // Render ONE combined results page
  this.currentStep = 'combined-results';
  this.combinedAnalysis = data;
  this.render();
}
```

### Phase 4: Cleanup âœ…
- Delete: `api.gemini.body-shape-analysis.tsx`
- Delete: `api.gemini.color-season-analysis.tsx`
- Merge celebrity logic into combined endpoint
- Keep: `api.gemini.recommendations.tsx` (products)

---

## âœ… **FINAL CHECKLIST**

- [ ] Create combined analysis endpoint
- [ ] Build comprehensive Gemini prompt
- [ ] Update frontend flow (remove intermediate pages)
- [ ] Design combined results page UI
- [ ] Test with all quiz data
- [ ] Verify cost per request
- [ ] Delete old endpoints
- [ ] Update ARCHITECTURE.md
- [ ] Test celebrity matches with values
- [ ] Deploy to production

---

## ğŸ’¯ **SUMMARY**

âœ… **2 Gemini calls total**
âœ… **4 analysis sections in ONE page:**
   1. Body Shape Analysis
   2. Color Season Analysis
   3. Values Analysis (AI-analyzed!)
   4. Celebrity Matches (uses all 3!)
âœ… **All quiz data passed**
âœ… **Cost: $0.053 per user** (3.6% savings)
âœ… **Better UX** (faster, cleaner flow)
âœ… **More comprehensive** (values get AI analysis!)

**Ready to implement! ğŸš€**
